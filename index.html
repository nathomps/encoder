<html>
<head>
<script src="encoder.js"></script>
</head>

<body>
<div id="canvas"></div>
<div id="fileSelector"></div>

<script language=JavaScript>
var decoder = undefined;

/**
 * Set up the canvas for drawing.
 */
var canvas = document.getElementById('canvas');
if (canvas) {
  canvas.innerHTML="<canvas id='pixelsCanvas' width='"+Decoder.prototype.decoderFrameWidth+"' height='"+Decoder.prototype.decoderFrameHeight+"' style='border:1px solid #d3d3d3;'>Your browser does not support HTML5 Canvas.</canvas>";
}
var canvasContext = document.getElementById("pixelsCanvas").getContext("2d");

/**
 * Setup the file selector.
 */
var fileSelector = document.getElementById('fileSelector');
// Check for the various File API support.
if (fileSelector) {
  if (window.File &&
      window.FileReader &&
      window.FileList &&
      window.Blob) {
    fileSelector.innerHTML = '<input type="file" id="fileSelector" name="video_source" />';

  } else {
    fileSelector.style['display'] = 'block';
    fileSelector.innerHTML = '<p>Browser Does Not Support HTML5 File API</p>';
  }
}

/*
function copyFromDecoder(myCanvasContext, myDecoder) {
  var imageData = myCanvasContext.createImageData(myDecoder.decoderFrameWidth, myDecoder.decoderFrameHeight);
  console.log("0",myDecoder.decoderRgbaArray[0]);
  console.log("1",myDecoder.decoderRgbaArray[1]);
  console.log("2",myDecoder.decoderRgbaArray[2]);
  console.log("3",myDecoder.decoderRgbaArray[3]);
  for (var i = 0; i < myDecoder.decoderRgbaArray.length; i++) {
    imageData.data[i] = myDecoder.decoderRgbaArray[i];
  }
  myCanvasContext.putImageData(imageData, 0, 0);
}
copyFromDecoder(canvasContext, decoder);
*/


/**
 * Handle file selection.
 */
var handleFileSelect = function(canvasContext) {
  return function(evt) {
    var files = evt.target.files; // list of File objects
    // we only care about one file
    var file = files[0];
    decoder = new Decoder(file);
  }
}(canvasContext, decoder);

document.getElementById('fileSelector').addEventListener('change', handleFileSelect, false);

/**
 * Updates the canvas to switch rgb color.
 */
var handleMouseUp = function(canvasContext) {
  var localContext = canvasContext;
  var width = Decoder.prototype.decoderFrameWidth;
  var height = Decoder.prototype.decoderFrameHeight;
  var color = 0;
  return function (evt) {
    var imageData = localContext.createImageData(width, height);
    for (var x = 0; x < width; x++) {
      for (var y = 0; y < height; y++) {
        var index = Decoder.prototype.rgbaStartIndex(x, y, width, height);
        //var index = (x + (y * width)) * 4;
        imageData.data[index + 0] = 0;
        imageData.data[index + 1] = 0;
        imageData.data[index + 2] = 0;
        imageData.data[index + 3] = 255;
        imageData.data[index + (color % 3)] = 255;
      }
    }
    color++;

    if (decoder !== undefined) {
      decoder.decodeFrame(imageData.data);
    }
    localContext.putImageData(imageData, 0, 0);
  }
}(canvasContext, decoder);
document.onmouseup = handleMouseUp;


</script>

</body>
</html>
